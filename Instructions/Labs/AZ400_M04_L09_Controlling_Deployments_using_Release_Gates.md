---
lab:
  title: 릴리스 게이트를 사용하여 배포 제어
  module: 'Module 04: Design and implement a release strategy'
---

# <a name="controlling-deployments-using-release-gates"></a>릴리스 게이트를 사용하여 배포 제어

# <a name="student-lab-manual"></a>학생용 랩 매뉴얼

## <a name="lab-requirements"></a>랩 요구 사항

- 이 랩은 **Microsoft Edge** 또는 [Azure DevOps 지원 브라우저](https://docs.microsoft.com/en-us/azure/devops/server/compatibility?view=azure-devops#web-portal-supported-browsers)가 필요합니다.

- **Azure DevOps 조직 설정:** 이 랩에 사용할 수 있는 Azure DevOps 조직이 아직 없으면 [조직 또는 프로젝트 컬렉션 만들기](https://docs.microsoft.com/en-us/azure/devops/organizations/accounts/create-organization?view=azure-devops)에서 제공되는 지침에 따라 조직을 만듭니다.

- 기존 Azure 구독을 확인하거나 새 구독을 만듭니다.

- Azure 구독의 Owner 역할, 그리고 Azure 구독과 연결된 Azure AD 테넌트의 전역 관리자 역할이 지정되어 있는 Microsoft 계정 또는 Azure AD 계정이 있는지 확인합니다. 자세한 내용은 [Azure Portal을 사용하여 Azure 역할 할당 목록 표시](https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-list-portal) 및 [Azure Active Directory에서 관리자 역할 확인 및 할당](https://docs.microsoft.com/en-us/azure/active-directory/roles/manage-roles-portal#view-my-roles)을 참조하세요.

## <a name="lab-overview"></a>랩 개요

이 랩에서는 배포 게이트의 구성을 살펴보고 배포 게이트를 사용하여 Azure Pipelines 실행을 제어하는 방법을 자세히 확인합니다. 배포 게이트 구현 방식을 파악하기 위해 Azure 웹앱용 환경 2개를 사용하여 릴리스 정의를 구성합니다. 또한 앱의 실행을 차단하는 버그가 없을 때만 Canary 환경에 앱을 배포하고, Azure Monitor의 Application Insights에 활성 경고가 없을 때만 Canary 환경을 완료 상태로 표시합니다.

릴리스 파이프라인은 애플리케이션을 다양한 환경에 배포할 수 있는 엔드투엔드 릴리스 프로세스를 지정합니다. 작업과 태스크를 사용하면 각 환경으로 애플리케이션을 배포하는 전체 과정을 자동화할 수 있습니다. 가급적이면 애플리케이션에 대한 새 업데이트가 모든 사용자에게 동시에 노출되지 않는 것이 좋습니다. 즉, 업데이트는 단계별로 표시하는 것이 좋습니다. 가령 일부 사용자에게 업데이트를 먼저 표시하여 사용 방식을 모니터링한 다음 초기 사용자 세트에서 확인된 경험을 토대로 하여 다른 사용자에게 업데이트를 표시할 수 있습니다.

승인과 게이트를 사용하여 릴리스에서 배포의 시작 및 완료를 제어할 수 있습니다. 사용자가 수동으로 배포를 승인 또는 거부할 때까지 기다릴 수 있습니다. 릴리스 게이트를 사용하면, 릴리스가 다음 환경으로 승격되기 전에 충족해야 하는 애플리케이션 상태 조건을 지정할 수 있습니다. 환경 배포 전 또는 후에 지정된 모든 게이트가 통과하거나 정의된 시간 제한에 도달하여 실패할 때까지 계속 자동으로 평가됩니다.

게이트는 배포 전 조건 또는 배포 후 조건 패널의 릴리스 정의에서 환경에 추가할 수 있습니다. 여러 게이트를 환경 조건에 추가하여 릴리스에 대한 모든 입력이 성공적으로 완료되도록 할 수 있습니다.

예를 들어

- 배포 전 게이트를 사용하면 빌드를 환경에 배포하기 전에 작업 항목이나 문제 관리 시스템에 활성 문제가 없음을 확인할 수 있습니다.
- 배포 후 게이트를 사용하면 앱을 배포한 후 릴리스를 다음 환경으로 승격하기 전에 앱의 모니터링 또는 인시던트 관리 시스템에 인시던트가 발생하지 않았음을 확인할 수 있습니다.

모든 계정에는 기본적으로 4가지 유형의 게이트가 포함되어 있습니다.

- Azure 함수 호출: Azure 함수 실행을 트리거하여 정상적으로 완료되는지 확인합니다.
- Azure Monitor 경고 쿼리: 활성 경고에 대해 구성된 Azure Monitor 경고 규칙을 준수합니다.
- REST API 호출: REST API를 호출하고 응답이 정상 반환되면 작업을 계속 진행합니다.
- 작업 항목 쿼리: 쿼리에서 반환되는 일치하는 작업 항목 수가 임계값 내에 있는지 확인합니다.

## <a name="objectives"></a>목표

이 랩을 완료하면 다음 작업을 수행할 수 있습니다.

- 릴리스 파이프라인을 구성합니다.
- 릴리스 게이트 구성
- 릴리스 게이트를 테스트합니다.

## <a name="estimated-timing-75-minutes"></a>예상 소요 시간: 75분

## <a name="instructions"></a>Instructions

### <a name="exercise-0-configure-the-lab-prerequisites"></a>연습 0: 랩 필수 구성 요소 구성

이 연습에서는 랩의 필수 구성 요소를 설정합니다. 구체적으로는 [eShopOnWeb](https://github.com/MicrosoftLearning/eShopOnWeb)을 기반으로 하여 새 Azure DevOps 프로젝트와 리포지토리를 설정합니다.

#### <a name="task-1--skip-if-done-create-and-configure-the-team-project"></a>작업 1: (완료된 경우 건너뛰기) 팀 프로젝트 만들기 및 구성

이 작업에서는 여러 랩에서 사용할 **eShopOnWeb_ReleaseGates** Azure DevOps 프로젝트를 만듭니다.

1.  랩 컴퓨터의 브라우저 창에서 Azure DevOps 조직을 엽니다. **새 프로젝트**를 클릭합니다. 프로젝트 이름을 **eShopOnWeb_ReleaseGates**로 설정하고 다른 필드는 기본값으로 둡니다. **만들기**를 클릭합니다.

    ![프로젝트 만들기](images/create-project.png)

#### <a name="task-2--skip-if-done-import-eshoponweb-git-repository"></a>작업 2: (완료된 경우 건너뛰기) eShopOnWeb Git 리포지토리 가져오기

이 작업에서는 여러 랩에서 사용할 eShopOnWeb Git 리포지토리를 가져옵니다.

1.  랩 컴퓨터의 브라우저 창에서 Azure DevOps 조직과 이전에 만든 **eShopOnWeb_ReleaseGates** 프로젝트를 엽니다. **Repos > 파일**, **리포지토리 가져오기**를 클릭합니다. **가져오기**를 선택합니다. **Git 리포지토리 가져오기** 창에서 다음 URL https://github.com/MicrosoftLearning/eShopOnWeb.git 을 붙여넣고 **가져오기**를 클릭합니다.

    ![리포지토리 가져오기](images/import-repo.png)

1.  리포지토리는 다음과 같은 방식으로 구성됩니다.
    - **.ado** 폴더에는 Azure DevOps YAML 파이프라인이 포함되어 있습니다.
    - 컨테이너를 사용(VS Code 또는 GitHub Codespaces에서 로컬로 사용)하여 개발하는 **.devcontainer** 폴더 컨테이너 설정
    - **.azure** 폴더에는 일부 랩 시나리오에서 사용되는 코드 템플릿으로 Bicep&ARM 인프라가 포함되어 있습니다.
    - **.github** 폴더 컨테이너 YAML GitHub 워크플로 정의.
    - **src** 폴더에는 랩 시나리오에서 사용되는 .NET 6 웹 사이트가 포함되어 있습니다.


#### <a name="task-2-create-two-azure-web-apps"></a>작업 2: Azure 웹앱 2개 만들기

이 작업에서는 Azure Pipelines를 통해 애플리케이션을 배포할 **Canary** 및 **Production** 환경을 나타내는 Azure 웹앱 2개를 만듭니다.

1. 랩 컴퓨터에서 웹 브라우저를 시작하여 [**Azure Portal**](https://portal.azure.com)로 이동한 다음, 이 랩에서 사용할 Azure 구독의 Owner 역할, 그리고 해당 구독과 연결된 Azure AD 테넌트의 전역 관리자 역할을 가진 사용자 계정으로 로그인합니다.
1. Azure Portal의 페이지 위쪽 검색 텍스트 상자 바로 오른쪽에 있는 **Cloud Shell** 아이콘을 클릭합니다.
1. **Bash**와 **PowerShell** 중 선택하라는 메시지가 표시되면 **Bash**를 선택합니다.

    >**참고**: **Cloud Shell**을 처음 시작했는데 **탑재된 스토리지 없음**이라는 메시지가 표시되면 이 랩에서 사용하는 구독을 선택하고 **스토리지 만들기**를 선택합니다.

1. **Bash** 프롬프트의 **Cloud Shell** 창에서 다음 명령을 실행하여 리소스 그룹을 만듭니다. 여기서 `<region>` 자리 표시자는 Azure 웹앱 2개를 호스트할 Azure 지역의 이름(예: 'westeurope', 'centralus' 또는 사용자가 선택하는 기타 사용 가능한 지역)으로 바꿉니다.

    > **참고**: 가능한 위치는 다음 명령을 실행하여 찾을 수 있습니다. `<region>`에 대한 **이름**: `az account list-locations -o table` 사용

    ```bash
    REGION='centralus'
    RESOURCEGROUPNAME='az400m04l09-RG'
    az group create -n $RESOURCEGROUPNAME -l $REGION
    ```

1. App Service 계획을 만들려면 다음 명령을 실행합니다.

    ```bash
    SERVICEPLANNAME='az400m04l09-sp1'
    az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
    ```

1.  고유한 앱 이름을 지정하여 웹앱 2개를 만듭니다.
 
     ```bash
     SUFFIX=$RANDOM$RANDOM
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-Canary
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n RGATES$SUFFIX-Prod
     ```

    > **참고**: Canary 웹앱의 이름을 기록합니다. 이 랩의 후반부에서 필요합니다.

1. Web App Services Resources 프로비저닝 프로세스가 완료될 때까지 기다린 후 **Cloud Shell** 창을 닫습니다.

#### <a name="task-3-configure-an-application-insights-resource"></a>작업 3: Application Insights 리소스 구성

1. Azure Portal에서 페이지 위쪽의 **검색 리소스, 서비스 및 문서** 텍스트 상자를 사용하여 **Application Insights**를 검색한 다음 결과 목록에서 **Application Insights**를 선택합니다.
1. **Application Insights** 블레이드에서 **+ 만들기**를 선택합니다.
1. **Application Insights** 블레이드의 **기본 사항** 탭에서 다음 설정을 지정합니다(다른 설정은 기본값으로 유지).

    | 설정 | 값 |
    | --- | --- |
    | Resource group | **az400m04l09-RG** |
    | Name | 이전 작업에서 기록한 Canary 웹앱의 이름 |
    | 지역 | 이전 작업에서 초반에서 웹앱을 배포한 것과 동일한 Azure 지역 |
    | 리소스 모드 | **클래식** |

    > **참고**: 사용 중단 관련 메시지는 무시하세요. 이 랩의 후반부에서 사용할 연속 통합 사용 DevOps 작업이 실패하지 않도록 하려면 이렇게 해야 합니다.

1. **검토 + 만들기**를 클릭한 다음, **만들기**를 클릭합니다.
1. 프로비저닝 프로세스가 완료될 때까지 기다립니다.
1. Azure Portal에서 이전 작업에서 만든 **az400m04l09-RG** 리소스 그룹으로 이동합니다.
1. 리소스 목록에서 **Canary** 웹앱을 클릭합니다.
1. **Canary** 웹앱 페이지 왼쪽의 세로 메뉴에 있는 **설정** 섹션에서 **Application Insights**를 클릭합니다.
1. **Application Insights** 블레이드에서 **Application Insights 켜기**를 클릭합니다.
1. **리소스 변경** 섹션에서 **기존 리소스 선택** 옵션을 클릭하고 기존 리소스 목록에서 새로 만든 Application Insight 리소스를 선택한 다음 **적용**을 클릭합니다. 그리고 작업을 확인하라는 메시지가 표시되면 **예**를 클릭합니다.
1. 변경 내용이 적용될 때까지 기다립니다.

    > **참고**: 여기서는 이 랩 뒷부분에서 사용할 모니터 경고를 만듭니다.
1. 동일한 **설정** / **Application Insights** 메뉴 옵션에서 **Application Insight 데이터 보기**를 선택합니다. 이렇게 하면 Azure Portal의 Application Insights 블레이드로 리디렉션됩니다.
1.  Application Insights 리소스 블레이드의 **모니터링** 섹션에서 **경고**를 클릭한 다음, **만들기 > 경고 규칙**을 클릭합니다.
1.  **신호 선택** 블레이드의 **신호 이름으로 검색** 텍스트 상자에 **실패한 요청**을 입력한 후 선택합니다. 
1.  **경고 규칙 만들기** 블레이드의 **조건** 섹션에서 **임계값**을 **고정**으로 설정하고, 다른 기본 설정의 유효성을 다음과 같이 검사합니다.
- 집계 형식: Count
- 연산자: 다음보다 큼
- 단위: 개수
1. **임계값** 텍스트 상자에 **0**을 입력하고 **다음:작업**을 클릭합니다. **작업** 설정 블레이드에서 아무것도 변경하지 말고 **세부 정보** 섹션에서 다음 매개 변수를 정의합니다.

    | 설정 | 값 |
    | --- | --- |
    | 심각도 | **2- 경고** |
    | 경고 규칙 이름 | **RGATESCanary_FailedRequests** |
    | 고급 옵션: 자동으로 경고 해결 | **선택 취소** |

    > **참고**: 메트릭 경고 규칙을 활성화하려면 최대 10분이 걸릴 수 있습니다.

    > **참고**: 가용성 99% 미만, 서버 응답 시간 5초 초과, 서버 예외 0 초과 등의 다른 메트릭용으로 여러 경고 규칙을 만들 수 있습니다.

1. **검토+만들기**를 클릭하여 경고 규칙 만들기를 확인하고 **만들기**를 클릭하여 다시 한 번 확인합니다. 경고 규칙이 성공적으로 만들어질 때까지 기다립니다.

### <a name="exercise-1-configure-the-build-pipeline"></a>연습 1: 빌드 파이프라인 구성

이 연습에서는 .NET 6 eShopOnWeb 웹 애플리케이션 소스 코드에 대한 릴리스 아티팩트(웹 배포 zip 패키지)를 준비합니다.

1. [Azure DevOps 포털](https://dev.azure.com)에서 이 랩의 앞부분에서 만들었던 **eShopOnWeb_ReleaseGates** 프로젝트로 이동합니다.
1. 프로젝트 내에서 **파이프라인**으로 이동합니다.
1. **파이프라인 만들기**를 클릭합니다.
1. **코드 위치** 단계에서 **Azure Repos(Git)** 를 선택합니다.
1. **리포지토리 선택**에서 **eShopOnWeb_ReleaseGates**를 선택합니다.
1. **파이프라인 구성** 단계에서 목록을 아래로 스크롤하여 **기존 Azure Pipelines YAML 파일**을 선택합니다.
1. **기존 YAML 파일 선택**에서 **main**을 분기로 선택하고 **/.ado/eshoponweb-ci.yml**을 경로로 선택합니다.
1. **계속**을 클릭합니다.
1. YAML 파이프라인 화면에서 **실행**을 클릭하여 빌드 파이프라인을 시작합니다.
1. 몇 초 후에 작업의 상태가 **실행 중**으로 전환됩니다. 소스 코드에 대한 경고는 무시하십시오.
1. **빌드** 상태 줄을 클릭하여 자세한 **실행 중인 작업** 창으로 이동합니다. 
1. 모든 단계가 성공적으로 완료(녹색 확인 표시)될 때까지 기다립니다. 평균 2~3분 정도 소요됩니다.
1. 빌드 파이프라인 작업이 성공적으로 완료되면 빌드 아티팩트 유효성을 검사합니다. 작업 상태 페이지에서 **요약** 탭으로 이동합니다. **관련 항목** 아래에 **2개 게시됨**으로 표시됩니다. 해당 링크를 선택합니다. 
1. 표시되는 **아티팩트** 페이지에서 **>Bicep** 및 **>WebSite**를 참조하십시오.
1. **WebSite**를 엽니다. **BlazorAdmin.zip** 및 **Web.zip**을 살펴봅니다. 예정된 릴리스 파이프라인에서 **Web.zip** 아티팩트를 사용할 예정입니다.

### <a name="exercise-2-configure-the-release-pipeline"></a>연습 2: 릴리스 파이프라인 구성

이 연습에서는 릴리스 파이프라인을 구성합니다.

#### <a name="task-1-set-up-release-tasks"></a>작업 1: 릴리스 작업 설정

이 작업에서는 릴리스 파이프라인의 일부로 릴리스 작업을 설정합니다.

1. Azure DevOps 포털에서 **eShopOnWeb_ReleaseGates** 프로젝트의 세로 탐색 창에서 **파이프라인**을 선택한 다음, **파이프라인** 섹션 내에서 **릴리스**를 클릭합니다.
1. **새 파이프라인**을 클릭합니다.
1. **템플릿 선택** 창에서 **Azure App Service 배포**(애플리케이션을 Azure App Service에 배포)를 **선택**합니다. **주요** 템플릿 목록에서 Windows, Linux, 컨테이너, 함수 앱 또는 WebJobs의 웹앱 중에서 선택합니다.
1. **적용**을 클릭합니다.
1. 표시되는 **스테이지** 창에서 기본 '스테이지 1'의 스테이지 이름을 **Canary**로 업데이트합니다. **X** 단추를 사용하여 팝업 창을 닫습니다. 이제 릴리스 파이프라인의 그래픽 편집기에 있으며, Canary 스테이지가 표시되어 있습니다.
1. Canary 스테이지 위로 마우스를 올리고 **복제** 단추를 클릭하여 Canary 스테이지를 추가 스테이지로 복사합니다. 이 스테이지의 이름을 **Production**으로 설정합니다.

    > **참고**: 파이프라인에는 이제 **Canary** 및 **Production**이라는 이름의 스테이지 2개가 포함되어 있습니다.

1. **파이프라인** 탭에서 **아티팩트 추가** 사각형을 선택하고 **원본(빌드 파이프라인)** 필드에서 **eShopOnWeb_ReleaseGates**를 선택합니다. **추가**를 클릭하여 아티팩트 선택 사항을 확인합니다.
1. **아티팩트** 사각형에서 **연속 통합 트리거**(번개 모양)가 표시되어 있는지 살펴보십시오. **연속 배포 트리거** 설정을 열려면 이를 클릭합니다. 연속 배포 트리거를 클릭하면 전환을 토글하여 이를 활성화할 수 있습니다. 다른 설정은 모두 기본값으로 유지하고 **연속 배포 트리거** 창 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다.
1. **Canary 환경** 단계 내에서 **작업 1개, 태스크 2개** 레이블을 클릭하고 이 페이지 내에서 해당 태스크를 검토합니다.

    > **참고**: Canary 환경에는 각각 아티팩트 패키지를 Azure 웹앱에 게시하는 1개의 작업이 있습니다.

1. **모든 파이프라인 > 새 릴리스 파이프라인** 창에서 **Canary** 스테이지가 선택되었는지 확인합니다. **Azure 구독** 드롭다운 목록에서 Azure 구독을 선택하고 **권한 부여**를 클릭합니다. 메시지가 표시되면 Azure 구독의 Owner 역할이 지정된 사용자 계정을 사용하여 인증합니다.
1. 앱 유형이 'Windows의 웹앱'으로 설정되어 있는지 확인합니다. 그 다음, **App Service 이름** 드롭다운 목록에서 **Canary** 웹앱의 이름을 선택합니다.
1. **Azure App Service 배포** 작업을 선택합니다. **패키지 또는 폴더** 필드에서 '$(System.DefaultWorkingDirectory)/ **/*.zip'의 기본값을 '$(System.DefaultWorkingDirectory)/** /Web.zip'**으로 업데이트합니다. 

    > 작업 탭 옆에 느낌표가 표시됩니다. Production 스테이지에 대한 설정을 구성해야 하므로 이 느낌표가 표시되는 건 정상입니다.

1. **모든 파이프라인 > 새 릴리스 파이프라인** 창에서 **파이프라인** 탭으로 이동하고 이번에는 **프로덕션** 스테이지 내에서 **작업 1개, 태스크 2개** 레이블을 클릭합니다. 이전의 Canary 스테이지와 유사한 방식으로 파이프라인 설정을 완료합니다. 작업 탭/프로덕션 배포 프로세스 아래의 **Azure 구독** 드롭다운 목록에서 **Canary 환경** 스테이지에 대해 사용한 Azure 구독을 선택합니다(**사용 가능한 Azure 서비스 연결** 아래에 표시됨). 이렇게 하는 이유는 구독을 사용하도록 권한을 부여할 때 이미 서비스 연결을 만들었기 때문입니다.
1. **App Service 이름** 드롭다운 목록에서 **프로덕션** 웹앱의 이름을 선택합니다.
1. **Azure App Service 배포** 작업을 선택합니다. **패키지 또는 폴더** 필드에서 '$(System.DefaultWorkingDirectory)/ **/*.zip'의 기본값을 '$(System.DefaultWorkingDirectory)/** /Web.zip'**으로 업데이트합니다. 
1. **모든 파이프라인 > 새 릴리스 파이프라인** 창에서 **저장**을 클릭하고, **저장** 대화 상자에서 **확인**을 클릭합니다.

이제 릴리스 파이프라인을 성공적으로 구성했습니다.

1. **EshopOnWeb_ReleaseGates** 프로젝트가 표시된 브라우저 창의 세로 탐색 창에 있는 **파이프라인** 섹션에서 **파이프라인**을 클릭합니다.
1. **파이프라인** 창에서 **eShopOnWeb_ReleaseGates** 빌드 파이프라인을 나타내는 항목을 클릭한 다음, **eShopOnWeb_ReleaseGates** 창에서 **파이프라인 실행**을 클릭합니다.
1. **파이프라인 실행** 페이지에서 기본 설정을 수락하고 **실행**을 클릭하여 파이프라인을 트리거합니다. **빌드 파이프라인이 완료될 때까지 기다립니다**.

    > **참고**: 빌드가 정상적으로 완료되면 릴리스가 자동으로 트리거되며 애플리케이션이 두 환경에 배포됩니다. 빌드 파이프라인이 성공적으로 완료되면 릴리스 작업의 유효성을 검사합니다.

1. 세로 탐색 창의 **파이프라인** 섹션에서 **릴리스**를 클릭하고 **eShopOnWeb_ReleaseGates** 창에서 가장 최신 릴리스를 나타내는 항목을 클릭합니다.
1. **eShopOnWeb_ReleaseGates > Release-1** 블레이드에서 릴리스 진행률을 추적하여 두 웹앱으로의 배포가 정상적으로 완료되었는지 확인합니다.
1. Azure Portal 인터페이스로 전환하여 **az400m04l09-RG** 리소스 그룹으로 이동한 다음 리소스 목록에서 **Canary** 웹앱을 클릭합니다. 그런 후에 웹앱 블레이드에서 **찾아보기**를 클릭하여 새 웹 브라우저 탭에서 웹 페이지(전자 상거래 웹사이트)가 정상적으로 로드되는지 확인합니다.
1. Azure Portal 인터페이스로 다시 전환하여 **az400m04l09-RG** 리소스 그룹으로 다시 이동한 다음 리소스 목록에서 **Production** 웹앱을 클릭합니다. 그런 후에 웹앱 블레이드에서 **찾아보기**를 클릭하여 새 웹 브라우저 탭에서 웹 페이지가 정상적으로 로드되는지 확인합니다.
1. **EShopOnWeb** 웹 사이트가 표시된 웹 브라우저 탭을 닫습니다.

    > **참고**: 이제 애플리케이션에서 CI/CD가 구성되었습니다. 다음 연습에서는 품질 게이트를 고급 릴리스 파이프라인의 일부로 설정합니다.

### <a name="exercise-3-configure-release-gates"></a>연습 3: 릴리스 게이트 구성

이 연습에서는 릴리스 파이프라인에서 품질 게이트를 설정합니다.

#### <a name="task-1-configure-pre-deployment-gates-for-approvals"></a>작업 1: 승인을 위한 배포 전 게이트 구성

이 작업에서는 배포 전 게이트를 구성합니다.

1. Azure DevOps 포털이 표시된 웹 브라우저 창으로 전환하고 **EshopOnWeb_ReleaseGates** 프로젝트를 엽니다. 세로 탐색 창의 **파이프라인** 섹션에서 **릴리스**를 클릭하고 **새 릴리스 파이프라인** 창에서 **편집**을 클릭합니다.
1. **모든 파이프라인 > 새 릴리스 파이프라인** 창에서 **Canary 환경** 스테이지를 나타내는 사각형의 왼쪽 모서리에 있는 **배포 전 조건**을 나타내는 타원을 클릭합니다.
1. **배포 전 조건** 창에서 **배포 전 승인** 슬라이더를 **사용으로 설정**하고 **승인자** 텍스트 상자에 Azure DevOps 계정 이름을 입력한 다음 선택합니다.

    > **참고**: 실제 시나리오에서 이는 사용자의 고유한 이름 대신 DevOps 팀 이름 별칭으로 표시됩니다.

1. 사전 승인 설정을 **저장**하고 팝업 창을 닫습니다.
1. **릴리스 만들기**를 클릭하고 팝업 창에서 **만들기** 단추를 눌러 확인합니다.
1. 'Release-2'가 생성되었다는 녹색 확인 메시지가 표시되는지 확인합니다. 'Release-2' 링크를 클릭하여 세부 정보로 이동합니다.
1. **Canary** 스테이지가 **승인 보류 중** 상태입니다. **승인** 단추를 클릭합니다. 이렇게 하면 Canary 스테이지가 다시 시작됩니다.

#### <a name="task-2-configure-post-deployment-gates-for-azure-monitor"></a>작업 2: Azure Monitor를 위한 배포 후 게이트 구성

이 작업에서는 Canary 환경의 배포 후 게이트를 사용하도록 설정합니다.

1.  **모든 파이프라인 > 새 릴리스 파이프라인** 창으로 돌아와 **Canary 환경** 스테이지를 나타내는 사각형의 오른쪽 모서리에 있는 **배포 후 조건**을 나타내는 타원을 클릭합니다.
1.  **배포 후 조건** 창에서 **게이트** 슬라이더를 **사용으로 설정**하고 **+ 추가**를 클릭한 다음 팝업 메뉴에서 **Azure Monitor 경고 쿼리**를 클릭합니다.
1.  **배포 후 조건** 창의 **Azure Monitor 경고 쿼리** 섹션에 있는 **Azure 구독** 드롭다운 목록에서 Azure 구독에 연결을 나타내는 **서비스 연결** 항목을 선택하고 **리소스 그룹** 드롭다운 목록에서 **az400m04l09-RG** 항목을 선택합니다.
1. **배포 후 조건** 창에서 **고급** 섹션을 확장하고 다음 옵션을 구성합니다.

- 필터 유형: **없음**
- 심각도: **Sev0, Sev1, Sev2, Sev3, Sev4**
- 시간 범위: **지난 시간**
- 경고 상태: **승인됨, 새로 만들기**
- 모니터 조건: **발생함**

1.  **배포 후 조건** 창에서 **평가 옵션**을 확장하고 다음 옵션을 구성합니다.

- **게이트 재평가 간격** 값을 **5분**으로 설정합니다.
- **이 시간 후에 게이트가 실패하는 시간 제한** 값을 **8분**으로 설정합니다.
- **게이트 성공 시 승인 요청** 옵션을 선택합니다.

    > **참고**: 샘플링 간격과 시간 제한은 연동되므로 게이트는 적절한 간격으로 함수를 호출하며, 시간 제한에 해당하는 기간 내의 동일 샘플링 간격 동안 배포가 정상적으로 완료되지 않으면 배포를 거부합니다.

1. **배포 후 조건 창** 오른쪽 위의 **x** 표시를 클릭하여 창을 닫습니다.
1. **새 릴리스 파이프라인** 창으로 돌아와 **저장**을 클릭하고 **저장** 대화 상자에서 **확인**을 클릭합니다.

### <a name="exercise-4-test-release-gates"></a>연습 4: 릴리스 게이트 테스트

이 연습에서는 애플리케이션을 업데이트하여 릴리스 게이트를 테스트합니다. 애플리케이션을 업데이트하면 배포가 트리거됩니다.

#### <a name="task-1-update-and-deploy-application-after-adding-release-gates"></a>작업 1: 릴리스 게이트 추가 후 애플리케이션 업데이트 및 배포

이 작업에서는 릴리스 게이트를 사용하여 릴리스 프로세스를 추적합니다.

1. Azure Portal의 '리소스, 서비스 및 문서 검색' 필드에 **경고**를 입력하여 Azure Monitor의 경고 서비스를 엽니다.
1. **심각도 2 - 경고**가 목록에 표시된 **경고가 1개** 이상 있어야 합니다. 이전 연습에서 웹 사이트의 유효성을 검사할 때 트리거가 발생했습니다.

    > ** 참고:** 경고가 아직 표시되지 않은 경우 몇 분 정도 더 기다리십시오. 브라우저에서 Canary-URL로 다시 이동하면 경고 속도를 높일 수 있습니다.

1. Azure DevOps 포털로 돌아가서 **EShopOnWeb-Release Gates** 프로젝트를 엽니다. **파이프라인**으로 이동하여 **릴리스**를 선택하고 **새 릴리스 파이프라인**을 선택합니다.
1. **릴리스 만들기** 단추를 클릭합니다.
1. 릴리스 파이프라인이 시작될 때까지 기다렸다가 Canary 스테이지 릴리스 작업을 **승인**합니다.
1. Canary 릴리스 스테이지가 성공적으로 완료될 때까지 기다립니다. **배포 후 게이트**가 어떻게 **평가 게이트** 상태로 전환되는지 살펴보십시오.  **평가 게이트** 아이콘을 클릭합니다.
1. **Azure Monitor 경고 쿼리**의 경우, 초기 실패 상태를 살펴봅니다.
1. 릴리스 파이프라인을 다음 5분 동안 보류 중인 상태로 둡니다. 5분이 지나면 두 번째 평가가 다시 실패하는 걸 볼 수 있습니다.
1. Canary 웹앱에 대해 트리거된 Application Insights 경고가 있기 때문에 이는 예상된 동작입니다.

    > **참고**: 예외로 인해 트리거된 경고가 있으므로 **Azure Monitor 쿼리** 게이트는 실패합니다. 그러므로 **프로덕션** 환경으로의 배포도 중단됩니다.

1. 3분 더 기다렸다가 릴리스 게이트의 상태를 다시 확인합니다. 이제 초기 릴리스 게이트를 확인한 지 8분이 넘었고 초기 Application Insight 경고가 '실행됨' 작업으로 트리거된 지 8분이 지났으므로, 프로덕션 릴리스 스테이지의 배포도 허용되었기 때문에 릴리스 게이트가 성공해야 합니다.

### <a name="exercise-5-remove-the-azure-lab-resources"></a>연습 5: Azure 랩 리소스 제거

이 연습에서는 예상치 못한 비용이 발생하지 않도록 이 랩에서 프로비전한 Azure 리소스를 제거합니다.

>**참고**: 더 이상 사용하지 않는 새로 만든 Azure 리소스는 모두 제거하세요. 사용되지 않는 리소스를 제거하면 예기치 않은 요금이 발생하지 않습니다.

#### <a name="task-1-remove-the-azure-lab-resources"></a>작업 1: Azure 랩 리소스 제거

이 작업에서는 Azure Cloud Shell을 사용하여 불필요한 비용이 발생하지 않도록 이 랩에서 프로비전한 Azure 리소스를 제거합니다.

1. Azure Portal의 **Cloud Shell** 창에서 **Bash** 세션을 시작합니다.
1. 다음 명령을 실행하여 이 모듈의 전체 랩에서 생성된 모든 리소스 그룹을 나열합니다.

    ```sh
    az group list --query "[?starts_with(name,'az400m04l09-RG')].name" --output tsv
    ```

1. 다음 명령을 실행하여 이 모듈의 랩 전체에서 만든 모든 리소스 그룹을 삭제합니다.

    ```sh
    az group list --query "[?starts_with(name,'az400m04l09-RG')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    >**참고**: 명령은 비동기적으로 실행되므로(--nowait 매개 변수에 의해 결정됨) 동일한 Bash 세션 내에서 즉시 다른 Azure CLI 명령을 실행할 수 있지만 리소스 그룹이 실제로 제거되기까지 몇 분 정도 걸립니다.

## <a name="review"></a>검토

이 랩에서는 릴리스 파이프라인을 구성한 다음 릴리스 게이트를 구성하고 테스트했습니다.
